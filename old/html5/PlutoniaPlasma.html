<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Plutonia Plasma</title>
    <script type="text/javascript"><!--
window.addEventListener('load', function () {
  // Get the canvas element.
  var elem = document.getElementById('myCanvas');
  if (!elem || !elem.getContext) {
    return;
  }

  // Get the canvas 2d context.
  var context = elem.getContext('2d');
  if (!context || !context.putImageData) {
    return;
  }

  var imgd = false,
      w = 512, h = 512,
      x = 0,  y = 0;

  // Not all browsers implement createImageData. On such browsers we obtain the 
  // ImageData object using the getImageData method. The worst-case scenario is 
  // to create an object *similar* to the ImageData object and hope for the best 
  // luck.
  if (context.createImageData) {
    imgd = context.createImageData(w, h);
  } else if (context.getImageData) {
    imgd = context.getImageData(0, 0, w, h);
  } else {
    imgd = {'width' : w, 'height' : h, 'data' : new Array(w*h*4)};
  }
  var pix = imgd.data;

  // Generate the palette
  var palette = [];
  for( var i = 0; i < 64; i++ ) {
    palette[(i*4)+0] = 0;
    palette[(i*4)+1] = 255 -((i<<2)+1);
    palette[(i*4)+2] = i << 2;
    palette[(i*4)+3] = 255;

    palette[256 + (i*4)+0] = 0;
    palette[256 + (i*4)+1] = ((i<<2)+1);
    palette[256 + (i*4)+2] = 255;
    palette[256 + (i*4)+3] = 255;

    palette[512 + (i*4)+0] = 0;
    palette[512 + (i*4)+1] = 255 - ((i<<2)+1);
    palette[512 + (i*4)+2] = 255 - ((i<<2)+1);
    palette[512 + (i*4)+3] = 255;

    palette[768 + (i*4)+0] = 0;
    palette[768 + (i*4)+1] = ((i<<2)+1);
    palette[768 + (i*4)+2] = 0;
    palette[768 + (i*4)+3] = 255;
  }
/*
  for( var i = 0, n = pix.length; i < n; i++ ) {
     pix[i] = palette[i % 1024];
  }
*/

  // Generate the arcsin table
  var asin = [];
  var rad = 0;
  for( var i = 0; i < 512; i++ ) {
    rad = ( i * 0.703125 ) * 0.0174532;
    asin[i] = Math.sin(rad) * 1023; 
  }

  var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  var tpos1 = 0, tpos2 = 0, tpos3 = 3, tpos4 = 0;

  function draw() {
          var pixeloffset = 0;
          for( var i = 0; i < w; i++ ) {
            tpos1 = pos1 + 5;
            tpos2 = pos2 + 2;

            tpos3 &= 511;
            tpos4 &= 511;

            for( var j = 0; j < h; j++) {
              tpos1 &= 511;
              tpos2 &= 511;

              var x = asin[tpos1] + asin[tpos2] + asin[tpos3] + asin[tpos4];
              var index = 128 + ( x >> 4 );
              index &= 255;

              pix[pixeloffset] = palette[index<<2];
              pix[pixeloffset + 1] = palette[(index<<2)+1];
              pix[pixeloffset + 2] = palette[(index<<2)+2];
              pix[pixeloffset + 3] = palette[(index<<2)+3];
              pixeloffset += 4;

              tpos1 += 5;
              tpos2 += 2;
            }

            tpos4 += 3;
            tpos3 += 1;
          }
          pos1 += 9;
          pos3 += 8;
          tpos4 = pos4;
          tpos3 = pos3;

          // Draw the ImageData object.
          context.putImageData(imgd, 0, 0); // was x, y
  }

  setInterval( draw, 40 );
}, false);
    // --></script>
  </head>
  <body>
    <p><canvas id="myCanvas" width="512" height="512">Your browser does not have 
    support for Canvas.  You should see: <span 
      style="display:block;width:50px;height:50px;background:#f77">&nbsp;</span></canvas> </p>
    <p><audio src="./plutonia.mp3" autoplay="autoplay" controls="controls">Your browser does not support the audio element.</audio></p>
  </body>
</html>
